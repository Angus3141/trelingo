<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <base target="_top">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Trelingo – Italian Quiz</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <!-- React & ReactDOM (UMD builds) -->
  <script src="https://unpkg.com/react@17/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js" crossorigin></script>
  <!-- Babel (for inline JSX) -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="bg-gray-50">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useMemo } = React;

    /* ---------------------- UTILITIES ---------------------- */
    let itVoice = null;
    function loadVoices() {
      const voices = speechSynthesis.getVoices();
      itVoice = voices.find(v => v.lang === 'it-IT' && (v.name === 'Alice' || v.default)) || voices.find(v => v.lang === 'it-IT');
    }
    speechSynthesis.onvoiceschanged = loadVoices;
    loadVoices();

    const speak = text => {
      if (!text) return;
      const u = new SpeechSynthesisUtterance(text);
      u.lang = 'it-IT';
      if (itVoice) u.voice = itVoice;
      speechSynthesis.speak(u);
    };

    // Parse TSV published by Google Sheets -> objects
    function parseTsv(tsv) {
      const rows = tsv.trim().split('\n').map(r => r.split('\t'));
      const headers = rows[0];
      return rows.slice(1).map(row => {
        const tmp = {};
        headers.forEach((h, i) => {
          if (h.startsWith('Correct words') || h.startsWith('Distractors')) {
            if (!tmp[h]) tmp[h] = [];
            try {
              if (row[i]) tmp[h].push(JSON.parse(row[i]));
            } catch (err) {/* ignore bad JSON */}
          } else {
            tmp[h] = row[i];
          }
        });
        return {
          topic: tmp['Topic name'],
          lang: tmp['Language code'],
          unit: tmp['Unit'],
          level: tmp['Level'],
          correct: Object.entries(tmp).filter(([k]) => k.startsWith('Correct words')).flatMap(([, v]) => v),
          distractors: Object.entries(tmp).filter(([k]) => k.startsWith('Distractors')).flatMap(([, v]) => v)
        };
      });
    }

    /* ---------------------- UI ELEMENTS -------------------- */
    const palette = {
      A1: ['#84cc16', '#bef264', '#d9f99d'],
      A2: ['#3b82f6', '#93c5fd', '#bfdbfe'],
      A3: ['#ef4444', '#fca5a5', '#fecaca']
    };
    const defPal = ['#7e22ce', '#a78bfa', '#c4b5fd'];

    const Pill = ({ title, label, color, onClick }) => (
      <button onClick={onClick} style={{ backgroundColor: color }} className="w-full text-left rounded-lg px-4 py-2 text-white relative overflow-hidden hover:opacity-90">
        {title && <span className="text-xs opacity-80 block leading-none">{title}</span>}
        <span className="text-base font-semibold">{label}</span>
        <i className="fa fa-arrow-right absolute right-3 top-1/2 -translate-y-1/2" />
      </button>
    );

    const Loader = () => (
      <div className="fixed inset-0 flex items-center justify-center bg-white z-50"><span className="text-gray-400">Loading…</span></div>
    );

    function Quiz({ data, onExit }) {
      const TOTAL = 15;
      const [count, setCount] = useState(0);
      const [cur, setCur] = useState(null);
      const [options, setOptions] = useState([]);
      const [pick, setPick] = useState('');
      const [feedback, setFeedback] = useState('');

      const shuffle = a => [...a].sort(() => Math.random() - 0.5);

      const nextQ = () => {
        const p = data.correct[Math.floor(Math.random() * data.correct.length)];
        const wrong = shuffle(data.correct.filter(x => x !== p))[0];
        const extra = shuffle(data.distractors).slice(0, 2);
        setCur(p);
        setOptions(shuffle([p.it, wrong.it, ...extra.map(e => e.it)]));
        setPick('');
        setFeedback('');
        speak(p.it);
      };

      useEffect(() => { if (data) nextQ(); }, [data]);

      const check = () => {
        if (!pick) return;
        if (pick === cur.it) {
          setFeedback('correct');
          setCount(c => c + 1);
          setTimeout(() => {
            if (count + 1 < TOTAL) nextQ(); else onExit();
          }, 600);
        } else {
          setFeedback('wrong');
          speak(cur.it);
        }
      };

      const prog = Math.round((count / TOTAL) * 100);

      return (
        <div className="space-y-6">
          <div className="flex items-center gap-4">
            <button className="text-gray-400" onClick={onExit}><i className="fa fa-xmark fa-xl" /></button>
            <div className="flex-1 h-2 bg-gray-200 rounded-full overflow-hidden"><div className="h-full bg-green-500" style={{ width: `${prog}%` }} /></div>
          </div>
          <button className="w-20 h-20 mx-auto bg-blue-500 text-white rounded-full flex items-center justify-center shadow" onClick={() => speak(cur?.it)}><i className="fa fa-volume-up fa-2x" /></button>
          <div className="space-y-3">
            {options.map(o => (
              <button key={o} onClick={() => setPick(o)} className={`w-full border rounded-lg px-4 py-2 text-left ${pick === o ? 'border-blue-600 bg-blue-50' : 'border-gray-300'}`}>{o}</button>
            ))}
          </div>
          {feedback && (
            <div className={`p-4 rounded-lg text-center ${feedback === 'correct' ? 'bg-green-50 border border-green-300' : 'bg-red-50 border border-red-300'}`}>
              {feedback === 'correct' ? 'Bravo!' : `La risposta corretta era ${cur.it}`}
            </div>
          )}
          <button disabled={!pick} onClick={check} className="w-full py-2 bg-green-600 text-white rounded disabled:opacity-50">{feedback ? 'Prossimo' : 'Controlla'}</button>
        </div>
      );
    }

    function App() {
      const [topics, setTopics] = useState(null);
      const [active, setActive] = useState(null);

      useEffect(() => {
        fetch('https://docs.google.com/spreadsheets/d/e/2PACX-1vRJELEbRqHtvqYSiDxrJ0ZTASU2IDmmpICfkU4JIt3xlnd66xbhZ4KJgtDY29Fe3XR3TD0n76rSBE6y/pub?output=tsv')
          .then(r => r.text())
          .then(parseTsv)
          .then(setTopics)
          .catch(err => console.error('Sheet fetch error:', err));
      }, []);

      const levels = useMemo(() => topics ? [...new Set(topics.map(t => t.level))] : [], [topics]);
      const unitsByLevel = useMemo(() => {
        const m = {};
        if (!topics) return m;
        topics.forEach(t => {
          if (!m[t.level]) m[t.level] = new Set();
          m[t.level].add(t.unit);
        });
        Object.keys(m).forEach(k => m[k] = [...m[k]]);
        return m;
      }, [topics]);

      const topicsByUnit = useMemo(() => {
        const m = {};
        if (!topics) return m;
        topics.forEach(t => {
          if (!m[t.unit]) m[t.unit] = [];
          m[t.unit].push(t);
        });
        return m;
      }, [topics]);

      if (!topics) return <Loader />;

      if (active) {
        const data = topics.find(t => t.topic === active);
        return <Quiz data={data} onExit={() => setActive(null)} />;
      }

      return (
        <div className="max-w-md mx-auto p-4 space-y-4">
          {levels.map(lvl => {
            const pal = palette[lvl] || defPal;
            return (
              <div key={lvl} className="space-y-2">
                <Pill title="LEVEL" label={lvl} color={pal[0]} onClick={() => {}} />
                <div className="pl-4 space-y-2">
                  {unitsByLevel[lvl].map(u => (
                    <div key={
